<!DOCTYPE html>
<html lang="th">

<head>
    <title>ระบบลงทะเบียนโฉนดที่ดิน Blockchain</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.4/dist/web3.min.js"></script>
    <style>
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ระบบลงทะเบียนโฉนดที่ดิน Blockchain</h1>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-secondary" id="reloadMetaMask">Reload MetaMask</button>
        </div>
        <div class="row">
            <!-- Form ลงทะเบียนโฉนด -->
            <div class="col-md-4">
                <h3>ฟอร์มลงทะเบียนโฉนด</h3>
                <form id="landForm">
                    <div class="mb-2">
                        <label for="ravang" class="form-label">ระวาง</label>
                        <input type="text" class="form-control" id="ravang" name="ravang" required>
                    </div>
                    <div class="mb-2">
                        <label for="landNumber" class="form-label">เลขที่ดิน</label>
                        <input type="text" class="form-control" id="landNumber" name="landNumber" required>
                    </div>
                    <div class="mb-2">
                        <label for="surveyPage" class="form-label">หน้าสำรวจ</label>
                        <input type="text" class="form-control" id="surveyPage" name="surveyPage" required>
                    </div>
                    <div class="mb-2">
                        <label for="subDistrict" class="form-label">ตำบล</label>
                        <input type="text" class="form-control" id="subDistrict" name="subDistrict" required>
                    </div>
                    <div class="mb-2">
                        <label for="number" class="form-label">เลขที่</label>
                        <input type="text" class="form-control" id="number" name="number" required>
                    </div>
                    <div class="mb-2">
                        <label for="volume" class="form-label">เล่ม</label>
                        <input type="text" class="form-control" id="volume" name="volume" required>
                    </div>
                    <div class="mb-2">
                        <label for="page" class="form-label">หน้า</label>
                        <input type="text" class="form-control" id="page" name="page" required>
                    </div>
                    <div class="mb-2">
                        <label for="district" class="form-label">อำเภอ</label>
                        <input type="text" class="form-control" id="district" name="district" required>
                    </div>
                    <div class="mb-2">
                        <label for="province" class="form-label">จังหวัด</label>
                        <input type="text" class="form-control" id="province" name="province" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">ลงทะเบียน</button>
                </form>
            </div>

            <!-- ตารางแสดงรายการโฉนด -->
            <div class="col-md-8">
                <h3>รายการโฉนดที่ลงทะเบียน</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>เวลาที่ลงทะเบียน</th>
                            <th>ระวาง</th>
                            <th>เลขที่ดิน</th>
                            <th>หน้าสำรวจ</th>
                            <th>ตำบล</th>
                            <th>เลขที่</th>
                            <th>เล่ม</th>
                            <th>หน้า</th>
                            <th>อำเภอ</th>
                            <th>จังหวัด</th>
                            <th>ผู้ลงทะเบียน</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <!-- รายการโฉนดจะมาแสดงตรงนี้ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        let web3;
        let contract;
        let accounts;

        const contractAddress = "0x4567346a776d489a3c072f65fa8d411bbb6e5f71";
        const contractABI = [
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "registrant", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                ],
                "name": "LandRegistered",
                "type": "event"
            },
            {
                "inputs": [
                    { "internalType": "string", "name": "ravang", "type": "string" },
                    { "internalType": "string", "name": "landNumber", "type": "string" },
                    { "internalType": "string", "name": "surveyPage", "type": "string" },
                    { "internalType": "string", "name": "subDistrict", "type": "string" },
                    { "internalType": "string", "name": "number", "type": "string" },
                    { "internalType": "string", "name": "volume", "type": "string" },
                    { "internalType": "string", "name": "page", "type": "string" },
                    { "internalType": "string", "name": "district", "type": "string" },
                    { "internalType": "string", "name": "province", "type": "string" }
                ],
                "name": "registerLand",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalRecords",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "index", "type": "uint256" }],
                "name": "getRecord",
                "outputs": [
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "string", "name": "", "type": "string" },
                    { "internalType": "address", "name": "", "type": "address" },
                    { "internalType": "uint256", "name": "", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const loadingSpinner = document.querySelector('.loading-spinner');
        const recordsTableBody = document.getElementById('recordsTableBody');
        const landForm = document.getElementById('landForm');
        const reloadMetaMaskBtn = document.getElementById('reloadMetaMask');

        function showLoading() {
            loadingSpinner.style.display = 'block';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        async function loadWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                await ethereum.request({ method: 'eth_requestAccounts' });
                accounts = await web3.eth.getAccounts();
                contract = new web3.eth.Contract(contractABI, contractAddress);
            } else {
                alert("กรุณาติดตั้ง MetaMask!");
            }
        }

        reloadMetaMaskBtn.addEventListener('click', async () => {
            showLoading();
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await ethereum.request({ method: 'wallet_requestPermissions', params: [{ eth_accounts: {} }] });
                    accounts = await web3.eth.getAccounts();
                    alert(`MetaMask reloaded! Active account: ${accounts[0]}`);
                } else {
                    alert("กรุณาติดตั้ง MetaMask!");
                }
            } catch (error) {
                console.error("MetaMask reload error:", error);
            } finally {
                hideLoading();
            }
        });

        async function loadRecords() {
            showLoading();
            try {
                const totalRecords = await contract.methods.getTotalRecords().call();
                recordsTableBody.innerHTML = '';
                for (let i = 0; i < totalRecords; i++) {
                    const record = await contract.methods.getRecord(i).call();
                    const date = new Date(record[10] * 1000).toLocaleString();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                      <td>${date}</td>
                      <td>${record[0]}</td>
                      <td>${record[1]}</td>
                      <td>${record[2]}</td>
                      <td>${record[3]}</td>
                      <td>${record[4]}</td>
                      <td>${record[5]}</td>
                      <td>${record[6]}</td>
                      <td>${record[7]}</td>
                      <td>${record[8]}</td>
                      <td>${record[9]}</td>
                    `;
                    recordsTableBody.appendChild(row);
                }
            } catch (error) {
                console.error("Error loading records:", error);
            } finally {
                hideLoading();
            }
        }

        landForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!web3 || !contract || !accounts || accounts.length === 0) {
                alert("กรุณาเชื่อมต่อ MetaMask ก่อนใช้งาน");
                return;
            }
            showLoading();
            try {
                const formData = new FormData(landForm);
                await contract.methods.registerLand(
                    formData.get('ravang'),
                    formData.get('landNumber'),
                    formData.get('surveyPage'),
                    formData.get('subDistrict'),
                    formData.get('number'),
                    formData.get('volume'),
                    formData.get('page'),
                    formData.get('district'),
                    formData.get('province')
                ).send({ from: accounts[0], gas: 3000000 });

                alert("ลงทะเบียนสำเร็จ!");
                landForm.reset();
                loadRecords();
            } catch (error) {
                console.error("Transaction error:", error);
                alert("เกิดข้อผิดพลาด: " + (error.message || error));
            } finally {
                hideLoading();
            }
        });

        window.addEventListener('load', async () => {
            await loadWeb3();
            await loadRecords();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
