import { useEffect, useState } from "react";
import { GetTransationByUserID, GetInfoUserByToken, UpdateTransactionBuyerAccept } from "../../service/https/bam/bam";
import './TransactionTimeline.css';
import Navbar from "../../component/user/Navbar";
import { Modal, Button } from "react-bootstrap";

function TransactionTimeline() {
    const [transactions, setTransactions] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [connectionStatus, setConnectionStatus] = useState<'connecting' | 'connected' | 'disconnected'>('connecting');
    const [userId, setUserId] = useState<number | null>(null);
    const [showModal, setShowModal] = useState(false);
    const [selectedTransaction, setSelectedTransaction] = useState<any>(null);

    useEffect(() => {
        const token = localStorage.getItem("token");
        const wsUrl = `ws://localhost:8080/ws/transactions?token=${token}`;
        const socket = new WebSocket(wsUrl);

        socket.onopen = () => setConnectionStatus('connected');
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            setTransactions((prev) => {
                const updated = [...prev];
                const index = updated.findIndex((tx) => tx.ID === data.ID);
                if (index >= 0) updated[index] = data;
                else updated.push(data);
                return updated;
            });
        };
        socket.onclose = () => setConnectionStatus('disconnected');
        socket.onerror = () => setConnectionStatus('disconnected');

        return () => socket.close();
    }, []);

    useEffect(() => {
        async function fetchTransactions() {
            try {
                setLoading(true);
                const user = await GetInfoUserByToken();
                setUserId(user.id);
                const apiTransactions = await GetTransationByUserID(user.id);
                setTransactions(apiTransactions ?? []);
            } catch (err) {
                setError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            } finally {
                setLoading(false);
            }
        }
        fetchTransactions();
    }, []);

    const handleSellerAccept = async (transaction: any) => {
        try {
            await UpdateTransactionBuyerAccept({
                sellerID: transaction.SellerID,
                buyerID: transaction.BuyerID,
                landID: transaction.LandID
            });
            
            setTransactions((prev) =>
                prev.map((tx) =>
                    tx.ID === transaction.ID ? { ...tx, SellerAccepted: true } : tx
                )
            );
        } catch (err) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢", err);
        }
    };

    const openModal = (tx: any) => {
        setSelectedTransaction(tx);
        setShowModal(true);
    };

    const closeModal = () => {
        setSelectedTransaction(null);
        setShowModal(false);
    };

    const confirmAccept = async () => {
        if (selectedTransaction) {
            await handleSellerAccept(selectedTransaction);
            closeModal();
        }
    };

    const getTransactionProgress = (tx: any) => {
        const steps = [tx.BuyerAccepted, tx.SellerAccepted, tx.MoneyChecked, tx.LandDepartmentApproved];
        const completed = steps.filter(Boolean).length;
        return { completed, total: 4, percentage: (completed / 4) * 100 };
    };

    const isTransactionCompleted = (tx: any) => {
        return [tx.BuyerAccepted, tx.SellerAccepted, tx.MoneyChecked, tx.LandDepartmentApproved].every(Boolean);
    };

    const formatDate = (dateString: string) => {
        return dateString ? new Date(dateString).toLocaleString('th-TH') : '-';
    };

    const formatAmount = (amount: number) => {
        return amount ? new Intl.NumberFormat('th-TH').format(amount) : '-';
    };

    if (loading) {
        return (
            <div className="page-container">
                <Navbar />
                <div className="content-wrapper">
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°...</p>
                    </div>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="page-container">
                <Navbar />
                <div className="content-wrapper">
                    <div className="error-container">
                        <div className="error-icon">‚ö†Ô∏è</div>
                        <h2>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                        <p>{error}</p>
                        <button 
                            className="btn btn-primary"
                            onClick={() => window.location.reload()}
                        >
                            ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    const buyerTransactions = transactions.filter(tx => tx.BuyerID === userId);
    const sellerTransactions = transactions.filter(tx => tx.SellerID === userId);

    const renderTransactionCard = (tx: any, userType: 'buyer' | 'seller') => {
        const progress = getTransactionProgress(tx);
        const isCompleted = isTransactionCompleted(tx);

        return (
            <div key={tx.ID} className="transaction-card">
                {/* Header Section */}
                <div className="card-header">
                    <div className="transaction-info">
                        <h3>Transaction #{tx.ID}</h3>
                        <div className="amount">
                            <span className="currency">‡∏ø</span>
                            <span className="value">{formatAmount(tx.Amount)}</span>
                        </div>
                    </div>
                    <div className="transaction-status">
                        <span className={`status-badge ${isCompleted ? 'completed' : 'in-progress'}`}>
                            {isCompleted ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
                        </span>
                    </div>
                </div>

                {/* Details Section */}
                <div className="card-body">
                    <div className="details-grid">
                        <div className="detail-item">
                            <label>‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
                            <span>{tx.Buyer?.Firstname ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        </div>
                        <div className="detail-item">
                            <label>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</label>
                            <span>{tx.Seller?.Firstname ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        </div>
                        <div className="detail-item">
                            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
                            <span>{tx.Buyer?.Email ?? '-'}</span>
                        </div>
                        <div className="detail-item">
                            <label>Token ID</label>
                            <span>{tx.Landtitle?.TokenID ?? '-'}</span>
                        </div>
                        <div className="detail-item">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>{tx.Typetransaction?.StatusNameTh ?? '-'}</span>
                        </div>
                        <div className="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</label>
                            <span>{formatDate(tx.CreatedAt)}</span>
                        </div>
                    </div>

                    {/* Progress Section */}
                    <div className="progress-section">
                        <div className="progress-header">
                            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                            <span className="progress-count">{progress.completed}/{progress.total}</span>
                        </div>
                        <div className="progress-bar">
                            <div 
                                className="progress-fill" 
                                style={{ width: `${progress.percentage}%` }}
                            ></div>
                        </div>
                        
                        <div className="steps-container">
                            {[
                                { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠', status: tx.BuyerAccepted },
                                { label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢', status: tx.SellerAccepted },
                                { label: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô', status: tx.MoneyChecked },
                                { label: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', status: tx.LandDepartmentApproved },
                            ].map((step, index) => (
                                <div key={index} className={`step-item ${step.status ? 'completed' : 'pending'}`}>
                                    <div className="step-indicator">
                                        {step.status ? '‚úì' : index + 1}
                                    </div>
                                    <span className="step-label">{step.label}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Action Section */}
                    {userType === 'buyer' && !tx.SellerAccepted && (
                        <div className="card-actions">
                            <button 
                                className="btn btn-primary"
                                onClick={() => openModal(tx)}
                            >
                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    return (
        <div className="page-container">
            <Navbar />
            <div className="content-wrapper">
                {/* Header */}
                <div className="page-header">
                    <div className="header-content">
                        <h1>Transaction Timeline</h1>
                    </div>
                </div>

                {/* Buyer Transactions */}
                <section className="transaction-section">
                    <div className="section-header">
                        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</h2>
                        <span className="transaction-count">({buyerTransactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                    </div>
                    <div className="transaction-list">
                        {buyerTransactions.length > 0 ? (
                            buyerTransactions.map(tx => renderTransactionCard(tx, 'buyer'))
                        ) : (
                            <div className="empty-state">
                                <div className="empty-icon">üìÑ</div>
                                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</p>
                            </div>
                        )}
                    </div>
                </section>

                {/* Seller Transactions */}
                <section className="transaction-section">
                    <div className="section-header">
                        <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</h2>
                        <span className="transaction-count">({sellerTransactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                    </div>
                    <div className="transaction-list">
                        {sellerTransactions.length > 0 ? (
                            sellerTransactions.map(tx => renderTransactionCard(tx, 'seller'))
                        ) : (
                            <div className="empty-state">
                                <div className="empty-icon">üìÑ</div>
                                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</p>
                            </div>
                        )}
                    </div>
                </section>

                {/* Confirmation Modal */}
                <Modal 
                    show={showModal} 
                    onHide={closeModal}
                    centered
                    className="confirmation-modal"
                >
                    <Modal.Header>
                        <Modal.Title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</Modal.Title>
                    </Modal.Header>
                    <Modal.Body>
                        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Transaction #{selectedTransaction?.ID} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                        <div className="transaction-summary">
                            <div className="summary-item">
                                <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                                <span>‡∏ø{formatAmount(selectedTransaction?.Amount)}</span>
                            </div>
                            <div className="summary-item">
                                <span>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</span>
                                <span>{selectedTransaction?.Seller?.Firstname}</span>
                            </div>
                        </div>
                    </Modal.Body>
                    <Modal.Footer>
                        <Button variant="outline-secondary" onClick={closeModal}>
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </Button>
                        <Button variant="primary" onClick={confirmAccept}>
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                        </Button>
                    </Modal.Footer>
                </Modal>
            </div>
        </div>
    );
}

export default TransactionTimeline;